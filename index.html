<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>宜络的秘密留言板</title>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            text-align: left;
            margin: 30px 0 10px;
            font-size: 2.2em;
        }
        .rules {
            color: #999;
            margin: 15px 0 25px;
            font-size: 0.95em;
        }
        #login {
            margin: 20px 0;
        }
        #message {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #444;
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
        }
        #message::placeholder {
            color: #666;
            font-style: italic;
        }
        button {
            background-color: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 20px;
            cursor: pointer;
            margin: 10px 0;
        }
        .comment {
            border-left: 3px solid #666;
            padding: 12px 20px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .comment-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .error {
            color: #ff4444;
            padding: 15px;
            border: 1px solid #ff4444;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>宜络的秘密留言板</h1>
    <div class="rules">
        <p>欢迎来到秘密留言板！</p>
        <p>请先登录，然后留下你的留言吧。</p>
        <p>• 留言限制 140 字</p>
        <p>• 每人只能提交一次</p>
        <p>• 凌晨 1 点到 6 点发送的留言会显示 🌙</p>
    </div>

    <div id="login">
        <button onclick="login()">通过 GitHub 登录</button>
    </div>
    <div id="form" style="display: none;">
        <textarea id="message" placeholder="畅所欲言..." maxlength="140"></textarea>
        <button onclick="submitMessage()">发送</button>
    </div>
    <div id="comments"></div>
    <div id="errorMsg" class="error" style="display: none;"></div>

    <script>
        const CLIENT_ID = 'Ov23livLf3n0TIOiFgMn';
        const REPO = 'yilo246/my-secret-board';
        const ISSUE_ID = 1;
        const BACKEND_URL = 'http://localhost:3000'; // 稍后替换为 Heroku URL
        let token = localStorage.getItem('github_token');
        let user = null;

        if (token) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            fetchUser();
            loadComments();
        }

        function login() {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&scope=repo&redirect_uri=${BACKEND_URL}/callback`;
            window.location.href = authUrl;
        }

        async function fetchUser() {
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('无法获取用户信息');
                user = await res.json();
            } catch (error) {
                showError('获取用户信息失败：' + error.message);
                localStorage.removeItem('github_token');
                window.location.reload();
            }
        }

        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('留言不能为空！');

            try {
                const comments = await fetch(`${BACKEND_URL}/comments?repo=${REPO}&issue=${ISSUE_ID}`, {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => res.json());
                if (comments.some(c => c.user.login === user.login)) {
                    return showError('你已经留过言了，每人只能留言一次！');
                }

                const res = await fetch(`${BACKEND_URL}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ repo: REPO, issue: ISSUE_ID, content: message })
                });
                if (!res.ok) throw new Error('提交失败');
                document.getElementById('message').value = '';
                loadComments();
            } catch (error) {
                showError('提交失败：' + error.message);
            }
        }

        async function loadComments() {
            try {
                const res = await fetch(`${BACKEND_URL}/comments?repo=${REPO}&issue=${ISSUE_ID}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('加载留言失败');
                const comments = await res.json();
                document.getElementById('comments').innerHTML = comments.map(c => {
                    const date = new Date(c.created_at);
                    const localHour = date.getHours();
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${localHour >= 1 && localHour < 6 ? '🌙 ' : ''}
                                ${date.toLocaleString()} · 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showError('加载留言失败：' + error.message);
            }
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (code) {
            fetch(`${BACKEND_URL}/callback?code=${code}`)
                .then(res => res.text())
                .then(t => {
                    token = t;
                    localStorage.setItem('github_token', token);
                    window.location.search = '';
                })
                .catch(err => showError('登录失败：' + err.message));
        }
    </script>
</body>
</html>
