<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>宜络的秘密留言板</title>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            text-align: left;
            margin: 30px 0 10px;
            font-size: 2.2em;
        }
        .rules {
            color: #ffffff; /* 改为和标题一样的亮度 */
            margin: 15px 0 25px;
            font-size: 0.95em;
        }
        #login {
            margin: 20px 0;
        }
        #message {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #444;
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
        }
        #message::placeholder {
            color: #666;
            font-style: italic;
        }
        button {
            background-color: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 20px;
            cursor: pointer;
            margin: 10px 0;
        }
        .comment {
            border-left: 3px solid #666;
            padding: 12px 20px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .comment-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .error {
            color: #ff4444;
            padding: 15px;
            border: 1px solid #ff4444;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>宜络的秘密留言板</h1>
    <div class="rules">
        <p>不错啊，你居然能找到这里来。来吧，说点什么</p>
        <p>• 你只可以说一句，但上限140个字。真的有人一句话会说这么多吗</p>
        <p>• 你的留言会一直被保存在这里。这玩意比石碑耐用</p>
        <p>• 凌晨 1 点到 6 点发送的留言前会显示 🌙，这是独属于夜猫子的标记</p>
    </div>

    <div id="login">
        <button onclick="console.log('点击了登录按钮'); login()">通过 GitHub 登录</button>
    </div>
    <div id="form" style="display: none;">
        <textarea id="message" placeholder="畅所欲言..." maxlength="140"></textarea>
        <button onclick="submitMessage()">发送</button>
    </div>
    <div id="comments"></div>
    <div id="errorMsg" class="error" style="display: none;"></div>

    <script>
        const CLIENT_ID = 'Ov23livLf3n0TIOiFgMn'; // 你的 GitHub OAuth 应用的 Client ID
        const REPO = 'yilo246/my-secret-board'; // 你的 GitHub 仓库
        const ISSUE_ID = 1; // 你的 Issue ID
        let token = localStorage.getItem('github_token');
        let user = null;

        // 检查是否已登录
        console.log('页面加载，检查已有 token:', token);
        if (token) {
            console.log('已有 token，隐藏登录按钮，显示表单');
            document.getElementById('login').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            fetchUser();
            loadComments();
        }

        // 页面加载后立即检查哈希片段
        function checkHash() {
            const hash = window.location.hash;
            console.log('检查哈希片段:', hash);
            if (hash) {
                const params = new URLSearchParams(hash.replace('#', ''));
                const accessToken = params.get('access_token');
                if (accessToken) {
                    console.log('获取到 access_token:', accessToken);
                    token = accessToken;
                    localStorage.setItem('github_token', token);
                    window.location.hash = '';
                    console.log('隐藏登录按钮，显示表单');
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('form').style.display = 'block';
                    fetchUser();
                    loadComments();
                } else {
                    console.log('哈希片段中没有 access_token');
                }
            } else {
                console.log('没有哈希片段');
            }
        }

        // 页面加载时检查
        window.addEventListener('load', () => {
            console.log('window.onload 触发');
            checkHash();
        });

        // 如果页面已经加载，立即检查（防止错过）
        if (document.readyState === 'complete') {
            console.log('页面已加载，立即检查哈希片段');
            checkHash();
        }

        // 监听哈希变化（以防错过）
        window.addEventListener('hashchange', () => {
            console.log('哈希变化，重新检查');
            checkHash();
        });

        // 登录函数
        function login() {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&scope=repo&response_type=token&redirect_uri=${window.location.origin}`;
            console.log('跳转到:', authUrl);
            setTimeout(() => {
                window.location.replace(authUrl);
            }, 100);
        }

        // 获取用户信息
        async function fetchUser() {
            try {
                console.log('开始获取用户信息');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('无法获取用户信息，状态码: ' + res.status);
                user = await res.json();
                console.log('用户信息获取成功:', user.login);
            } catch (error) {
                console.error('获取用户信息失败:', error.message);
                showError('获取用户信息失败：' + error.message);
                localStorage.removeItem('github_token');
                window.location.reload();
            }
        }

        // 提交留言
        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('留言不能为空！');

            try {
                console.log('检查是否已留言');
                const comments = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => res.json());
                if (comments.some(c => c.user.login === user.login)) {
                    return showError('你已经留过言了，每人只能留言一次！');
                }

                console.log('提交新留言:', message);
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: message })
                });
                if (!res.ok) throw new Error('提交失败，状态码: ' + res.status);
                document.getElementById('message').value = '';
                console.log('留言提交成功，重新加载留言');
                loadComments();
            } catch (error) {
                console.error('提交留言失败:', error.message);
                showError('提交失败：' + error.message);
            }
        }

        // 加载留言
        async function loadComments() {
            try {
                console.log('开始加载留言');
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('加载留言失败，状态码: ' + res.status);
                const comments = await res.json();
                console.log('留言加载成功，数量:', comments.length);
                document.getElementById('comments').innerHTML = comments.map(c => {
                    const date = new Date(c.created_at);
                    const localHour = date.getHours();
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${localHour >= 1 && localHour < 6 ? '🌙 ' : ''}
                                ${date.toLocaleString()} · 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载留言失败:', error.message);
                showError('加载留言失败：' + error.message);
            }
        }

        // 显示错误信息
        function showError(msg) {
            console.log('显示错误:', msg);
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
