<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</title>
    <style>
        /* ä¼˜åŒ–åçš„æ ·å¼ */
        body {
            background: #000000; /* çº¯é»‘èƒŒæ™¯ */
            color: #fff;
            font-family: 'Arial', 'Microsoft Yahei', sans-serif;
            max-width: 800px;
            margin: 20px 0 20px 20px; /* é å·¦å¯¹é½ */
            padding: 0;
            line-height: 1.6;
        }
        h1 {
            font-size: 2.4em;
            margin: 40px 0 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .rules {
            margin: 30px 0;
            padding: 20px;
            /* æ— èƒŒæ™¯æ¡† */
        }
        .rule-item {
            color: #999; /* ä¿æŒæœ€åˆçš„é€æ˜åº¦ */
            margin: 15px 0;
            padding-left: 10px;
            /* æ— ç«–æ  */
        }
        #message {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            margin: 20px 0;
            width: 100%;
            height: 120px;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #444;
        }
        .comment {
            background: #1a1a1a;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 4px solid #333;
        }
        .comment-header {
            color: #888;
            margin-bottom: 12px;
            font-size: 0.9em;
        }
        .error {
            background: #2d0000;
            color: #ff6666;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #ff4444;
        }
    </style>
</head>
<body>
    <h1>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</h1>
    
    <div class="rules">
        <p style="color: #fff; font-size: 1.1em;">ä¸é”™å•Šï¼Œä½ å±…ç„¶èƒ½æ‰¾åˆ°è¿™é‡Œæ¥ã€‚æ¥å§ï¼Œè¯´ç‚¹ä»€ä¹ˆ</p>
        <p class="rule-item">â€¢ ä½ åªå¯ä»¥è¯´ä¸€å¥ï¼Œä½†ä¸Šé™140ä¸ªå­—ã€‚çœŸçš„æœ‰äººä¸€å¥è¯ä¼šè¯´è¿™ä¹ˆå¤šå—</p>
        <p class="rule-item">â€¢ ä½ çš„ç•™è¨€ä¼šä¸€ç›´è¢«ä¿å­˜åœ¨è¿™é‡Œã€‚è¿™ç©æ„æ¯”çŸ³ç¢‘è€ç”¨</p>
        <p class="rule-item">â€¢ å‡Œæ™¨ 1 ç‚¹åˆ° 6 ç‚¹å‘é€çš„ç•™è¨€å‰ä¼šæ˜¾ç¤º ğŸŒ™ï¼Œè¿™æ˜¯éƒ¨åˆ†æ˜¯ç‹¬å±äºå¤œçŒ«å­çš„æ ‡è®°</p>
    </div>

    <div id="authSection">
        <button onclick="startAuthFlow()">é€šè¿‡ GitHub è®¤è¯</button>
    </div>

    <div id="postSection" style="display: none;">
        <textarea 
            id="message" 
            placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ•…äº‹...ï¼ˆåˆ«è¶…è¿‡140å­—å“¦ï¼‰" 
            maxlength="140"
        ></textarea>
        <button onclick="submitMessage()">æ°¸ä¹…ä¿å­˜</button>
    </div>

    <div id="commentsContainer"></div>
    <div id="errorDisplay" class="error" style="display: none;"></div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CLIENT_ID = 'Ov23livLf3n0TIOiFgMn';
        const REPO = 'yilo246/my-secret-board';
        const ISSUE_ID = 1;

        // è®¤è¯çŠ¶æ€ç®¡ç†
        let authState = {
            token: localStorage.getItem('gh_token') || null,
            user: null
        };

        // åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½ï¼Œæ£€æŸ¥ URL å’Œ token');
            if (window.location.hash.includes('access_token')) {
                console.log('æ£€æµ‹åˆ° access_tokenï¼Œå¤„ç†å›è°ƒ');
                handleOAuthCallback();
            } else if (authState.token) {
                console.log('å·²æœ‰ tokenï¼ŒéªŒè¯ token æœ‰æ•ˆæ€§');
                verifyToken();
            } else {
                console.log('æ—  tokenï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®');
            }
        });

        // ç›‘å¬å“ˆå¸Œå˜åŒ–
        window.addEventListener('hashchange', () => {
            console.log('å“ˆå¸Œå˜åŒ–ï¼Œé‡æ–°æ£€æŸ¥');
            if (window.location.hash.includes('access_token')) {
                console.log('æ£€æµ‹åˆ° access_tokenï¼Œå¤„ç†å›è°ƒ');
                handleOAuthCallback();
            }
        });

        // å¯åŠ¨è®¤è¯æµç¨‹
        function startAuthFlow() {
            try {
                console.log('å¯åŠ¨è®¤è¯æµç¨‹');
                const redirectUri = encodeURIComponent(window.location.origin);
                const scope = encodeURIComponent('user');
                const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&scope=${scope}`;
                console.log('è·³è½¬åˆ°:', authUrl);
                window.location.href = authUrl; // ç›´æ¥è·³è½¬
            } catch (error) {
                console.error('è·³è½¬å¤±è´¥:', error.message);
                showError('è·³è½¬åˆ° GitHub è®¤è¯é¡µé¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¤„ç†å›è°ƒ
        async function handleOAuthCallback() {
            try {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                
                console.log('è·å–åˆ° access_token:', accessToken);
                if (!accessToken) throw new Error('è®¤è¯å¤±è´¥ï¼šæ—  access_token');
                
                authState.token = accessToken;
                localStorage.setItem('gh_token', accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                console.error('OAuth å›è°ƒå¤„ç†å¤±è´¥:', error.message);
                showError('è®¤è¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUserProfile() {
            try {
                console.log('å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒçŠ¶æ€ç : ${res.status}, é”™è¯¯: ${errorData.message}`);
                }
                
                authState.user = await res.json();
                console.log('ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ:', authState.user.login);
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error.message);
                showError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š' + error.message);
                clearAuth();
            }
        }

        // éªŒè¯ token æœ‰æ•ˆæ€§
        async function verifyToken() {
            try {
                console.log('éªŒè¯ token æœ‰æ•ˆæ€§');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error(`token æ— æ•ˆï¼ŒçŠ¶æ€ç : ${res.status}`);
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                console.error('token éªŒè¯å¤±è´¥:', error.message);
                clearAuth();
            }
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('å†™ç‚¹ä»€ä¹ˆå†æäº¤å§');

            try {
                console.log('æ£€æŸ¥æ˜¯å¦å·²ç•™è¨€');
                const existing = await checkExistingComment();
                if (existing) return showError('æ¯äººåªèƒ½ç•™è¨€ä¸€æ¬¡å“¦');
                
                console.log('æäº¤æ–°ç•™è¨€:', message);
                await postNewComment(message);
                document.getElementById('message').value = '';
                loadComments();
            } catch (error) {
                handleSubmitError(error);
            }
        }

        // æ£€æŸ¥ç°æœ‰ç•™è¨€
        async function checkExistingComment() {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                headers: { Authorization: `Bearer ${authState.token}` }
            });
            if (!res.ok) throw new Error(`æ— æ³•æ£€æŸ¥ç•™è¨€ï¼ŒçŠ¶æ€ç : ${res.status}`);
            const comments = await res.json();
            return comments.some(c => c.user.login === authState.user.login);
        }

        // å‘å¸ƒæ–°ç•™è¨€
        async function postNewComment(content) {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${authState.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body: content })
            });
            
            if (!res.ok) throw new Error(`æäº¤å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.status}`);
            console.log('ç•™è¨€æäº¤æˆåŠŸ');
        }

        // åŠ è½½ç•™è¨€
        async function loadComments() {
            try {
                console.log('å¼€å§‹åŠ è½½ç•™è¨€');
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments?sort=created&direction=desc`, {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error(`åŠ è½½ç•™è¨€å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.status}`);
                
                const comments = await res.json();
                console.log('ç•™è¨€åŠ è½½æˆåŠŸï¼Œæ•°é‡:', comments.length);
                
                const html = comments.map(c => {
                    const date = new Date(c.created_at);
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${getMoonIcon(date)}
                                ${date.toLocaleString('zh-CN')} Â· 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('commentsContainer').innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error.message);
                if (error.message.includes('401')) {
                    showError('è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    clearAuth();
                } else {
                    showError('ç•™è¨€åŠ è½½å¤±è´¥');
                }
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getMoonIcon(date) {
            const hour = date.getHours();
            return (hour >= 1 && hour < 6) ? 'ğŸŒ™ ' : '';
        }

        function showPostSection() {
            console.log('æ˜¾ç¤ºç•™è¨€è¡¨å•');
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('postSection').style.display = 'block';
        }

        function clearAuth() {
            console.log('æ¸…é™¤è®¤è¯ä¿¡æ¯');
            localStorage.removeItem('gh_token');
            authState = { token: null, user: null };
            window.location.reload();
        }

        function showError(msg) {
            console.log('æ˜¾ç¤ºé”™è¯¯:', msg);
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function handleSubmitError(error) {
            console.error('æäº¤å¤±è´¥:', error.message);
            if (error.message.includes('401')) {
                showError('è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                clearAuth();
            } else {
                showError('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        }
    </script>
</body>
</html>
