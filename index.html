<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</title>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            text-align: left;
            margin: 30px 0 10px;
            font-size: 2.2em;
        }
        .rules {
            color: #ffffff; /* æ”¹ä¸ºå’Œæ ‡é¢˜ä¸€æ ·çš„äº®åº¦ */
            margin: 15px 0 25px;
            font-size: 0.95em;
        }
        #login {
            margin: 20px 0;
        }
        #message {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #444;
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
        }
        #message::placeholder {
            color: #666;
            font-style: italic;
        }
        button {
            background-color: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 20px;
            cursor: pointer;
            margin: 10px 0;
        }
        .comment {
            border-left: 3px solid #666;
            padding: 12px 20px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .comment-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .error {
            color: #ff4444;
            padding: 15px;
            border: 1px solid #ff4444;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</h1>
    <div class="rules">
        <p>ä¸é”™å•Šï¼Œä½ å±…ç„¶èƒ½æ‰¾åˆ°è¿™é‡Œæ¥ã€‚æ¥å§ï¼Œè¯´ç‚¹ä»€ä¹ˆ</p>
        <p>â€¢ ä½ åªå¯ä»¥è¯´ä¸€å¥ï¼Œä½†ä¸Šé™140ä¸ªå­—ã€‚çœŸçš„æœ‰äººä¸€å¥è¯ä¼šè¯´è¿™ä¹ˆå¤šå—</p>
        <p>â€¢ ä½ çš„ç•™è¨€ä¼šä¸€ç›´è¢«ä¿å­˜åœ¨è¿™é‡Œã€‚è¿™ç©æ„æ¯”çŸ³ç¢‘è€ç”¨</p>
        <p>â€¢ å‡Œæ™¨ 1 ç‚¹åˆ° 6 ç‚¹å‘é€çš„ç•™è¨€å‰ä¼šæ˜¾ç¤º ğŸŒ™ï¼Œè¿™æ˜¯ç‹¬å±äºå¤œçŒ«å­çš„æ ‡è®°</p>
    </div>

    <div id="login">
        <button onclick="console.log('ç‚¹å‡»äº†ç™»å½•æŒ‰é’®'); login()">é€šè¿‡ GitHub ç™»å½•</button>
    </div>
    <div id="form" style="display: none;">
        <textarea id="message" placeholder="ç•…æ‰€æ¬²è¨€..." maxlength="140"></textarea>
        <button onclick="submitMessage()">å‘é€</button>
    </div>
    <div id="comments"></div>
    <div id="errorMsg" class="error" style="display: none;"></div>

    <script>
        const CLIENT_ID = 'Ov23livLf3n0TIOiFgMn'; // ä½ çš„ GitHub OAuth åº”ç”¨çš„ Client ID
        const REPO = 'yilo246/my-secret-board'; // ä½ çš„ GitHub ä»“åº“
        const ISSUE_ID = 1; // ä½ çš„ Issue ID
        let token = localStorage.getItem('github_token');
        let user = null;

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        console.log('é¡µé¢åŠ è½½ï¼Œæ£€æŸ¥å·²æœ‰ token:', token);
        if (token) {
            console.log('å·²æœ‰ tokenï¼Œéšè—ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºè¡¨å•');
            document.getElementById('login').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            fetchUser();
            loadComments();
        }

        // é¡µé¢åŠ è½½åç«‹å³æ£€æŸ¥å“ˆå¸Œç‰‡æ®µ
        function checkHash() {
            const hash = window.location.hash;
            console.log('æ£€æŸ¥å“ˆå¸Œç‰‡æ®µ:', hash);
            if (hash) {
                const params = new URLSearchParams(hash.replace('#', ''));
                const accessToken = params.get('access_token');
                if (accessToken) {
                    console.log('è·å–åˆ° access_token:', accessToken);
                    token = accessToken;
                    localStorage.setItem('github_token', token);
                    window.location.hash = '';
                    console.log('éšè—ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºè¡¨å•');
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('form').style.display = 'block';
                    fetchUser();
                    loadComments();
                } else {
                    console.log('å“ˆå¸Œç‰‡æ®µä¸­æ²¡æœ‰ access_token');
                }
            } else {
                console.log('æ²¡æœ‰å“ˆå¸Œç‰‡æ®µ');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('window.onload è§¦å‘');
            checkHash();
        });

        // å¦‚æœé¡µé¢å·²ç»åŠ è½½ï¼Œç«‹å³æ£€æŸ¥ï¼ˆé˜²æ­¢é”™è¿‡ï¼‰
        if (document.readyState === 'complete') {
            console.log('é¡µé¢å·²åŠ è½½ï¼Œç«‹å³æ£€æŸ¥å“ˆå¸Œç‰‡æ®µ');
            checkHash();
        }

        // ç›‘å¬å“ˆå¸Œå˜åŒ–ï¼ˆä»¥é˜²é”™è¿‡ï¼‰
        window.addEventListener('hashchange', () => {
            console.log('å“ˆå¸Œå˜åŒ–ï¼Œé‡æ–°æ£€æŸ¥');
            checkHash();
        });

        // ç™»å½•å‡½æ•°
        function login() {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&scope=repo&response_type=token&redirect_uri=${window.location.origin}`;
            console.log('è·³è½¬åˆ°:', authUrl);
            setTimeout(() => {
                window.location.replace(authUrl);
            }, 100);
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUser() {
            try {
                console.log('å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒçŠ¶æ€ç : ' + res.status);
                user = await res.json();
                console.log('ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ:', user.login);
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error.message);
                showError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š' + error.message);
                localStorage.removeItem('github_token');
                window.location.reload();
            }
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('ç•™è¨€ä¸èƒ½ä¸ºç©ºï¼');

            try {
                console.log('æ£€æŸ¥æ˜¯å¦å·²ç•™è¨€');
                const comments = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => res.json());
                if (comments.some(c => c.user.login === user.login)) {
                    return showError('ä½ å·²ç»ç•™è¿‡è¨€äº†ï¼Œæ¯äººåªèƒ½ç•™è¨€ä¸€æ¬¡ï¼');
                }

                console.log('æäº¤æ–°ç•™è¨€:', message);
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: message })
                });
                if (!res.ok) throw new Error('æäº¤å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + res.status);
                document.getElementById('message').value = '';
                console.log('ç•™è¨€æäº¤æˆåŠŸï¼Œé‡æ–°åŠ è½½ç•™è¨€');
                loadComments();
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±è´¥:', error.message);
                showError('æäº¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½ç•™è¨€
        async function loadComments() {
            try {
                console.log('å¼€å§‹åŠ è½½ç•™è¨€');
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('åŠ è½½ç•™è¨€å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + res.status);
                const comments = await res.json();
                console.log('ç•™è¨€åŠ è½½æˆåŠŸï¼Œæ•°é‡:', comments.length);
                document.getElementById('comments').innerHTML = comments.map(c => {
                    const date = new Date(c.created_at);
                    const localHour = date.getHours();
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${localHour >= 1 && localHour < 6 ? 'ğŸŒ™ ' : ''}
                                ${date.toLocaleString()} Â· 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error.message);
                showError('åŠ è½½ç•™è¨€å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(msg) {
            console.log('æ˜¾ç¤ºé”™è¯¯:', msg);
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
