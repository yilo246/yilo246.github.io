<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>宜络的秘密留言板</title>
    <style>
        /* 优化后的样式 */
        body {
            background: #000000; /* 纯黑背景 */
            color: #fff;
            font-family: 'Arial', 'Microsoft Yahei', sans-serif;
            max-width: 800px;
            margin: 20px 0 20px 20px; /* 靠左对齐 */
            padding: 0;
            line-height: 1.6;
        }
        h1 {
            font-size: 2.4em;
            margin: 40px 0 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .rules {
            margin: 30px 0;
            padding: 20px;
            /* 无背景框 */
        }
        .rule-item {
            color: #999; /* 保持最初的透明度 */
            margin: 15px 0;
            padding-left: 10px;
            /* 无竖杠 */
        }
        #message {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            margin: 20px 0;
            width: 100%;
            height: 120px;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #444;
        }
        .comment {
            background: #1a1a1a;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 4px solid #333;
        }
        .comment-header {
            color: #888;
            margin-bottom: 12px;
            font-size: 0.9em;
        }
        .error {
            background: #2d0000;
            color: #ff6666;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #ff4444;
        }
    </style>
</head>
<body>
    <h1>宜络的秘密留言板</h1>
    
    <div class="rules">
        <p style="color: #fff; font-size: 1.1em;">不错啊，你居然能找到这里来。来吧，说点什么</p>
        <p class="rule-item">• 你只可以说一句，但上限140个字。真的有人一句话会说这么多吗</p>
        <p class="rule-item">• 你的留言会一直被保存在这里。这玩意比石碑耐用</p>
        <p class="rule-item">• 凌晨 1 点到 6 点发送的留言前会显示 🌙，这是部分是独属于夜猫子的标记</p>
    </div>

    <div id="authSection">
        <button onclick="startAuthFlow()">通过 GitHub 认证</button>
    </div>

    <div id="postSection" style="display: none;">
        <textarea 
            id="message" 
            placeholder="在这里写下你的故事...（别超过140字哦）" 
            maxlength="140"
        ></textarea>
        <button onclick="submitMessage()">永久保存</button>
    </div>

    <div id="commentsContainer"></div>
    <div id="errorDisplay" class="error" style="display: none;"></div>

    <script>
        // 配置信息
        const CLIENT_ID = 'Ov23livLf3n0TIOiFgMn';
        const REPO = 'yilo246/my-secret-board';
        const ISSUE_ID = 1;

        // 认证状态管理
        let authState = {
            token: localStorage.getItem('gh_token') || null,
            user: null
        };

        // 初始化检查
        window.addEventListener('load', () => {
            console.log('页面加载，检查 URL 和 token');
            if (window.location.hash.includes('access_token')) {
                console.log('检测到 access_token，处理回调');
                handleOAuthCallback();
            } else if (authState.token) {
                console.log('已有 token，验证 token 有效性');
                verifyToken();
            } else {
                console.log('无 token，显示登录按钮');
            }
        });

        // 监听哈希变化
        window.addEventListener('hashchange', () => {
            console.log('哈希变化，重新检查');
            if (window.location.hash.includes('access_token')) {
                console.log('检测到 access_token，处理回调');
                handleOAuthCallback();
            }
        });

        // 启动认证流程
        function startAuthFlow() {
            try {
                console.log('启动认证流程');
                const redirectUri = encodeURIComponent(window.location.origin);
                const scope = encodeURIComponent('user');
                const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&scope=${scope}`;
                console.log('跳转到:', authUrl);
                window.location.href = authUrl; // 直接跳转
            } catch (error) {
                console.error('跳转失败:', error.message);
                showError('跳转到 GitHub 认证页面失败，请重试');
            }
        }

        // 处理回调
        async function handleOAuthCallback() {
            try {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                
                console.log('获取到 access_token:', accessToken);
                if (!accessToken) throw new Error('认证失败：无 access_token');
                
                authState.token = accessToken;
                localStorage.setItem('gh_token', accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                console.error('OAuth 回调处理失败:', error.message);
                showError('认证失败，请重试');
            }
        }

        // 获取用户信息
        async function fetchUserProfile() {
            try {
                console.log('开始获取用户信息');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`无法获取用户信息，状态码: ${res.status}, 错误: ${errorData.message}`);
                }
                
                authState.user = await res.json();
                console.log('用户信息获取成功:', authState.user.login);
            } catch (error) {
                console.error('获取用户信息失败:', error.message);
                showError('获取用户信息失败：' + error.message);
                clearAuth();
            }
        }

        // 验证 token 有效性
        async function verifyToken() {
            try {
                console.log('验证 token 有效性');
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error(`token 无效，状态码: ${res.status}`);
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                console.error('token 验证失败:', error.message);
                clearAuth();
            }
        }

        // 提交留言
        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('写点什么再提交吧');

            try {
                console.log('检查是否已留言');
                const existing = await checkExistingComment();
                if (existing) return showError('每人只能留言一次哦');
                
                console.log('提交新留言:', message);
                await postNewComment(message);
                document.getElementById('message').value = '';
                loadComments();
            } catch (error) {
                handleSubmitError(error);
            }
        }

        // 检查现有留言
        async function checkExistingComment() {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                headers: { Authorization: `Bearer ${authState.token}` }
            });
            if (!res.ok) throw new Error(`无法检查留言，状态码: ${res.status}`);
            const comments = await res.json();
            return comments.some(c => c.user.login === authState.user.login);
        }

        // 发布新留言
        async function postNewComment(content) {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${authState.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body: content })
            });
            
            if (!res.ok) throw new Error(`提交失败，状态码: ${res.status}`);
            console.log('留言提交成功');
        }

        // 加载留言
        async function loadComments() {
            try {
                console.log('开始加载留言');
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments?sort=created&direction=desc`, {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error(`加载留言失败，状态码: ${res.status}`);
                
                const comments = await res.json();
                console.log('留言加载成功，数量:', comments.length);
                
                const html = comments.map(c => {
                    const date = new Date(c.created_at);
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${getMoonIcon(date)}
                                ${date.toLocaleString('zh-CN')} · 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('commentsContainer').innerHTML = html;
            } catch (error) {
                console.error('加载留言失败:', error.message);
                if (error.message.includes('401')) {
                    showError('认证已过期，请重新登录');
                    clearAuth();
                } else {
                    showError('留言加载失败');
                }
            }
        }

        // 辅助函数
        function getMoonIcon(date) {
            const hour = date.getHours();
            return (hour >= 1 && hour < 6) ? '🌙 ' : '';
        }

        function showPostSection() {
            console.log('显示留言表单');
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('postSection').style.display = 'block';
        }

        function clearAuth() {
            console.log('清除认证信息');
            localStorage.removeItem('gh_token');
            authState = { token: null, user: null };
            window.location.reload();
        }

        function showError(msg) {
            console.log('显示错误:', msg);
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function handleSubmitError(error) {
            console.error('提交失败:', error.message);
            if (error.message.includes('401')) {
                showError('认证已过期，请重新登录');
                clearAuth();
            } else {
                showError('保存失败，请稍后再试');
            }
        }
    </script>
</body>
</html>
