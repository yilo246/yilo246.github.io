<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</title>
    <style>
        body {
            background: #000000;
            color: #fff;
            font-family: 'Arial', 'Microsoft Yahei', sans-serif;
            max-width: 800px;
            margin: 20px 0 20px 20px;
            padding: 0;
            line-height: 1.6;
        }
        h1 {
            font-size: 2.4em;
            margin: 40px 0 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .rules {
            margin: 30px 0;
            padding: 20px 20px 20px 0;
        }
        .rule-item {
            color: #999;
            margin: 15px 0;
            padding-left: 0;
        }
        #message {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            margin: 20px 0;
            width: 100%;
            height: 120px;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #444;
        }
        .comment {
            background: #1a1a1a;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 4px solid #333;
        }
        .comment-header {
            color: #888;
            margin-bottom: 12px;
            font-size: 0.9em;
        }
        .error {
            background: #2d0000;
            color: #ff6666;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #ff4444;
        }
    </style>
</head>
<body>
    <h1>å®œç»œçš„ç§˜å¯†ç•™è¨€æ¿</h1>
    
    <div class="rules">
        <p style="color: #fff; font-size: 1.1em;">ä¸é”™å•Šï¼Œä½ å±…ç„¶èƒ½æ‰¾åˆ°è¿™é‡Œã€‚æ¥å§ï¼Œè¯´ç‚¹ä»€ä¹ˆ</p>
        <p class="rule-item">â€¢ ä½ åªå¯ä»¥è¯´ä¸€å¥ï¼Œä½†ä¸Šé™æ˜¯140ä¸ªå­—</p>
        <p class="rule-item">â€¢ ä½ çš„ç•™è¨€ä¼šè¢«ä¸€ç›´ä¿å­˜åœ¨è¿™é‡Œã€‚è¿™ç©æ„å¯æ¯”çŸ³ç¢‘è€ç”¨</p>
        <p class="rule-item">â€¢ å‡Œæ™¨ 1 ç‚¹åˆ° 6 ç‚¹å‘é€çš„ç•™è¨€å‰ä¼šæ˜¾ç¤º ğŸŒ™ï¼Œè¿™æ˜¯ç‹¬å±äºå¤œçŒ«å­çš„æ ‡è®°</p>
    </div>

    <div id="authSection">
        <button id="authButton">é€šè¿‡ GitHub è®¤è¯</button>
    </div>

    <div id="postSection" style="display: none;">
        <textarea 
            id="message" 
            placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ•…äº‹...ï¼ˆåˆ«è¶…è¿‡140å­—å“¦ï¼‰" 
            maxlength="140"
        ></textarea>
        <button onclick="submitMessage()">æ°¸ä¹…ä¿å­˜</button>
    </div>

    <div id="commentsContainer"></div>
    <div id="errorDisplay" class="error" style="display: none;"></div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CLIENT_ID = 'Ov23li9e5kGBbzL2DVCV'; // ä½ çš„ Client ID
        const CLIENT_SECRET = '32a7af2c8562298083767d5ca32d3c2b107a4429'; // ä½ çš„ Client Secret
        const REPO = 'yilo246/my-secret-board'; // ä½ çš„ç”¨æˆ·åå’Œç•™è¨€ä»“åº“
        const ISSUE_ID = 1; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª issue

        // è®¤è¯çŠ¶æ€ç®¡ç†
        let authState = {
            token: localStorage.getItem('gh_token') || null,
            user: null
        };

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('authButton').addEventListener('click', () => {
            startAuthFlow();
        });

        // åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', () => {
            checkAuthParams();
        });

        // æ£€æŸ¥æˆæƒå‚æ•°
        function checkAuthParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                handleOAuthCallback(code);
            } else if (authState.token) {
                verifyToken();
            }
        }

        // å¯åŠ¨è®¤è¯æµç¨‹
        function startAuthFlow() {
            const redirectUri = encodeURIComponent(window.location.origin);
            const scope = encodeURIComponent('user');
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code`;
            window.location.assign(authUrl);
        }

        // å¤„ç†å›è°ƒï¼ˆæˆæƒç æ¨¡å¼ï¼‰
        async function handleOAuthCallback(code) {
            try {
                const redirectUri = window.location.origin;
                const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        code: code,
                        redirect_uri: redirectUri
                    })
                });

                const tokenData = await tokenResponse.json();
                if (tokenData.error) throw new Error(tokenData.error_description);

                const accessToken = tokenData.access_token;
                authState.token = accessToken;
                localStorage.setItem('gh_token', accessToken);
                
                window.history.replaceState({}, document.title, window.location.pathname);
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                showError('è®¤è¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                clearAuth();
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUserProfile() {
            const res = await fetch('https://api.github.com/user', {
                headers: { Authorization: `Bearer ${authState.token}` }
            });
            authState.user = await res.json();
        }

        // éªŒè¯ token æœ‰æ•ˆæ€§
        async function verifyToken() {
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error('token æ— æ•ˆ');
                await fetchUserProfile();
                showPostSection();
                loadComments();
            } catch (error) {
                clearAuth();
            }
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return showError('å†™ç‚¹ä»€ä¹ˆå†æäº¤å§');

            try {
                const existing = await checkExistingComment();
                if (existing) return showError('æ¯äººåªèƒ½ç•™è¨€ä¸€æ¬¡å“¦');
                
                await postNewComment(message);
                document.getElementById('message').value = '';
                loadComments();
            } catch (error) {
                showError('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        }

        // æ£€æŸ¥ç°æœ‰ç•™è¨€
        async function checkExistingComment() {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                headers: { Authorization: `Bearer ${authState.token}` }
            });
            const comments = await res.json();
            return comments.some(c => c.user.login === authState.user.login);
        }

        // å‘å¸ƒæ–°ç•™è¨€
        async function postNewComment(content) {
            const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${authState.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body: content })
            });
            if (!res.ok) throw new Error('æäº¤å¤±è´¥');
        }

        // åŠ è½½ç•™è¨€
        async function loadComments() {
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues/${ISSUE_ID}/comments?sort=created&direction=desc`, {
                    headers: { Authorization: `Bearer ${authState.token}` }
                });
                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const comments = await res.json();
                const html = comments.map(c => {
                    const date = new Date(c.created_at);
                    return `
                        <div class="comment">
                            <div class="comment-header">
                                ${getMoonIcon(date)}
                                ${date.toLocaleString('zh-CN')} Â· 
                                <span style="color:#666;">@${c.user.login}</span>
                            </div>
                            <div>${c.body}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('commentsContainer').innerHTML = html;
            } catch (error) {
                showError('ç•™è¨€åŠ è½½å¤±è´¥');
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getMoonIcon(date) {
            const hour = date.getHours();
            return (hour >= 1 && hour < 6) ? 'ğŸŒ™ ' : '';
        }

        function showPostSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('postSection').style.display = 'block';
        }

        function clearAuth() {
            localStorage.removeItem('gh_token');
            authState = { token: null, user: null };
            window.location.href = window.location.origin;
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
